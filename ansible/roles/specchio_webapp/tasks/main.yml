---

- name: Install OpenJDK
  package:
    name: java-1.8.0-openjdk
    state: latest

- name: Install unzip package
  package:
    name: unzip
    state: latest

- name: Download glassfish zip archive
  get_url:
    url: "{{ specchio_webapp_glassfish_download_url }}"
    dest: "/tmp/{{ specchio_webapp_glassfish_zip_name }}"
    checksum: "{{ specchio_webapp_glassfish_zip_checksum }}"

- name: Unzip glassfish archive
  unarchive:
    remote_src: yes
    src: "/tmp/{{ specchio_webapp_glassfish_zip_name }}"
    dest: /opt/

- name: Download mysql java connector tarball archive
  get_url:
    url: "{{ specchio_webapp_glassfish_mysql_java_connector_download_url }}"
    dest: "/tmp/{{ specchio_webapp_glassfish_mysql_java_connector_tarball_name }}"
    checksum: "{{ specchio_webapp_glassfish_mysql_java_connector_tarball_checksum }}"

- name: Unzip glassfish archive
  unarchive:
    remote_src: yes
    src: "/tmp/{{ specchio_webapp_glassfish_mysql_java_connector_tarball_name }}"
    dest: /opt/

- name: Copy mysql java connector to glassfish library directory
  copy:
    src: "/opt/mysql-connector-java-5.1.47/mysql-connector-java-5.1.47-bin.jar"
    dest: "{{ specchio_webapp_glassfish_domain_external_libraries_directory }}"
    remote_src: yes

- name: Create SPECCHIO webapp install directory
  file:
    path: "{{ specchio_webapp_directory }}"
    state: directory

- name: Download SPECCHIO webapp war
  get_url:
    url: "{{ specchio_webapp_download_url }}"
    dest: "{{ specchio_webapp_directory }}"

- name: Copy glassfish systemd unit file
  copy:
    src: glassfish.service
    dest: "{{ specchio_webapp_glassfish_systemd_unit_file }}"

- name: Render glassfish domain configuration
  template:
    src: domain.xml.j2
    dest: "{{ specchio_webapp_glassfish_domain_configuration_file }}"

- name: Start and enable glassfish service
  service:
      name: glassfish
      state: started
      enabled: yes

- name: Deploy webapp.war to glassfish
  command: "{{ specchio_webapp_glassfish_asadmin_file }} deploy --force {{ specchio_webapp_war }}"
