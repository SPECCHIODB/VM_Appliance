---

- name: Install mariadb package
  package:
    name: mariadb-server
    state: latest

- name: Enable mariadb service
  service:
    name: mariadb
    state: started
    enabled: yes

- name: Install python mysql library
  package:
    name: python2-PyMySQL
    state: latest

# We only want to run the SQL scripts if the database does not exist yet.

- name: check if DB exists
  shell: mysql -e 'SHOW DATABASES;' | grep 'specchio'
  register: dbstatus
  failed_when: dbstatus.rc == 2

- name: Import SPECCHIO database schema
  mysql_db:
    name: all
    state: import
    target: "{{ specchio_webapp_sql_directory }}/SPECCHIO_V3.2.0.sql"
  when: dbstatus.rc == 1

# Instead of using the mysql_user module to manage the database users, we use the existing SQL
# scripts. Those might change in the future. This way we will always be up to date.

- name: Replace sdb_admin password in SQL Script
  replace:
    path: "{{ specchio_webapp_sql_directory }}/sdb_admin_creation.sql"
    regexp: '(.*)sdb_admin_password(.*)$'
    replace: '\1{{ specchio_webapp_database_password }}\2'
    backup: yes
  when: dbstatus.rc == 1

- name: Create SPECCHIO database user
  mysql_db:
    name: all
    state: import
    target: "{{ specchio_webapp_sql_directory }}/sdb_admin_creation.sql"
  when: dbstatus.rc == 1
