---

- hosts: all
  become: yes
  become_user: root
  become_method: sudo
  vars:
    # TODO: Extract into Jenkins credentials
    - specchio_database_password:           'ALSOCHANGEME'
    - specchio_webapp_database_password:    '{{ specchio_database_password }}'
    - specchio_database_user_password:      '{{ specchio_database_password }}'
    - specchio_client_admin_password:       '{{ specchio_database_password }}'

  pre_tasks:
    - name: Update yum packages
      yum:
        name: '*'
        state: latest
        update_cache: yes

    - name: Install epel-release
      package:
        name: epel-release
        state: latest

    - name: Install GNOME desktop environment packages
      yum:
        name: "@^gnome-desktop-environment"
        state: latest

    - name: Install GNOME display manager package
      package:
        name: gdm
        state: latest

    - name: Set default target to "graphical"
      shell: systemctl set-default graphical.target

    - name: Add SPECCHIO group
      group:
        name: specchio
        state: present

    - name: Add SPECCHIO user
      user:
        name: specchio
        comment: SPECCHIO Spectral Information System
        home: /home/specchio
        group: specchio
        groups: wheel  # Add specchio user to sudo group
      ignore_errors: yes

  roles:
    - role: specchio_client
    - role: specchio_webapp

  post_tasks:
    - name: Install debugging and developments utils
      package:
        name: "{{ item }}"
        state: latest
      loop:
        - vim
        - curl
        - git
