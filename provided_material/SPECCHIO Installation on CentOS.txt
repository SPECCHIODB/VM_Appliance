SPECCHIO Installation on CentOS
-------------------------------
ahueni@geo.uzh.ch, 18th June 2015


- get CentOS 6.4 VM from http://virtualboxes.org/images/centos/

- switch bridged networking on (EHT0)

- Following are mainly VM related issues to get the host additions to work …

# Updated the system using yum.
yum -y update

# install gcc
yum groupinstall “Development Tools”

# align kernel and devel.
uname -a ; rpm -qa kernel\* | sort

- reboot

- install the host additions
->>> the ISO image is in the Virtual Box Application folder!!!!!

Install the Virtual Box Extensions as well!


After a reboot all is working!!!


- VM: Mount SPECCHIO host machine directory for easier install:

mount -t vboxsf SPECCHIO_Project /mnt





—— SPECCHIO Installation starts here …


-install mysql (https://www.linode.com/docs/databases/mysql/how-to-install-mysql-on-centos-7)

wget http://repo.mysql.com/mysql57-community-release-el7-11.noarch.rpm
sudo rpm -ivh mysql-community-release-el7-5.noarch.rpm
yum update

yum install mysql-server
sudo systemctl start mysqld

/sbin/service mysqld start

- initial password: https://www.digitalocean.com/community/questions/mysql-5-7-7-centos-7-el7-access-denied
sudo grep 'temporary password' /var/log/mysqld.log

/usr/bin/mysql -u root -p

ALTER USER root@localhost IDENTIFIED BY '5p3cch10_MySql_Root';

— update 17.9.2017:
- Edit /etc/my.cnf: add 
max_allowed_packet = 50M

— MySQL restart 

/sbin/service mysqld start


- get workbench
wget https://dl.fedoraproject.org/pub/epel/7/x86_64/e/epel-release-7-9.noarch.rpm
sudo yum install ./epel-release-7-9.noarch.rpm 

sudo yum install epel-release

- download mysql workbench RPM from mysql webpage

- Check that the passwords do not expire: default_password_lifetime = 0

SHOW VARIABLES where variable_name like '%life%';


- get jdk from: http://www.oracle.com/technetwork/java/javase/downloads/jdk7-downloads-1880260.html
- Note: JDK8 led to an error with glassfish!
-> CentOS7: java already installed.

// shell change also not really needed …
[root@localhost ~]# chsh -l
/bin/sh
/bin/bash
/sbin/nologin
/usr/bin/sh
/usr/bin/bash
/usr/sbin/nologin
/bin/tcsh
/bin/csh
[root@localhost ~]# chsh -s /bin/sh
Changing shell for root.
Shell changed.



- Add java path to /etc/profile

JAVA_HOME=/usr/lib/jvm/jdk1.7.0_80
export JAVA_HOME
PATH=$JAVA_HOME/bin:$PATH 
export PATH

// not sure where this really should go, or in .bashr or in the /etc/bashrc ….
sudo cp .profile /etc/profile.d



- Change hostname: SPECCHIOVM.specchio.ch
- Note: this must be done before installing glassfish, otherwise the certificate lists localhost.localdomain

gedit /etc/sysconfig/network

NETWORKING=yes
HOSTNAME=SPECCHIOVM2.specchio.ch



gedit /etc/hosts

127.0.0.1   SPECCHIOVM2.specchio.ch
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6



hostname SPECCHIOVM2.specchio.ch

// https://www.server-world.info/en/note?os=CentOS_7&p=hostname
hostnamectl set-hostname SPECCHIOVM2.specchio.ch


/bin/sh

// Note: run as root (using sudo ./glassfish-3.1.2.2-unix.sh does not work: the java path is not set!!!!)
./glassfish-3.1.2.2-unix.sh



- follow SPECCHIO server setup

- Glassfish admin: name = admin, password = admin


- Glassfish re-install due to wrong hostname setting:

sh-4.2# /opt/glassfish3/glassfish/bin/asadmin stop-domain
Waiting for the domain to stop 
Command stop-domain executed successfully.
sh-4.2# cd /opt/glassfish3/
sh-4.2# chmod +x ./uninstall.sh
sh-4.2# sh ./uninstall.sh

- remote glassfish directory
rm -r /opt/glassfish3


// Due to reinstall because hostname was not correct:

Services have already been created for this server.
Try deleting the files first like so:
         rm /etc/init.d/GlassFish_specchio
OR -- use the --force option and they will be deleted for you automatically.

##### List certificates in keystore

keytool -list -keystore specchio.keystore 


##### Authentication via keystore:
- Note: if you want to keep the certificates for the SPECCHIO online system within the keystore file, first copy the existing keystore file from the SPECCHIO Java Client; the import will then add your server certificate to the existing keystore.

keytool -export -alias s1as -keystore /opt/glassfish3/glassfish/domains/specchio/config/keystore.jks -file glassfish.crt
keytool -import -alias specchio_vm_2 -file glassfish.crt -keystore specchio.keystore


- copy specchio.keystore from install directory to SPECCHIO WebApp directory (SPECCHIO Java Client)



- Start Glassfish:

/opt/glassfish3/glassfish/bin/asadmin start-domain specchio



- start service
/opt/glassfish3/glassfish/bin/asadmin deploy --force /opt/glassfish3/glassfish/domains/specchio/bin/specchio-webapp.war






- MySQL: sdb_admin creation for localhost and any host to allow mysql connection from host machine
———

CREATE USER 'sdb_admin'@'localhost' IDENTIFIED BY '5p3cch10_SDB_VM';
INSERT INTO `specchio`.`specchio_user` (`user`, `first_name`, `last_name`, `email`, `admin`, `password`)
	VALUES ('sdb_admin', 'SPECCHIO', 'Administrator', '', 1, MD5('5p3cch10_SDB_VM'));
    
GRANT SELECT, DELETE, INSERT, UPDATE, ALTER, DROP, CREATE, CREATE VIEW, GRANT OPTION, TRIGGER ON `specchio`.* TO 'sdb_admin'@'localhost';
GRANT SELECT, DELETE, INSERT, UPDATE, CREATE TEMPORARY TABLES, GRANT OPTION ON `specchio_temp`.* TO 'sdb_admin'@'localhost';
GRANT SUPER, CREATE USER ON *.* TO 'sdb_admin'@'localhost';
GRANT INSERT ON `mysql`.`user` TO 'sdb_admin'@'localhost';
UPDATE `mysql`.`user`
	SET `Reload_priv`='Y', `Process_priv`='Y', `Update_priv`='Y', `Delete_priv`='Y', `Select_priv`='Y'
	WHERE `user`='sdb_admin' AND `host`='localhost';
FLUSH PRIVILEGES;


GRANT SELECT, DELETE, INSERT, UPDATE, ALTER, DROP, CREATE, CREATE VIEW, GRANT OPTION, TRIGGER ON `specchio`.* TO 'sdb_admin'@'%';
GRANT SELECT, DELETE, INSERT, UPDATE, CREATE TEMPORARY TABLES, GRANT OPTION ON `specchio_temp`.* TO 'sdb_admin'@'%';
GRANT SUPER, CREATE USER ON *.* TO 'sdb_admin'@'%';
GRANT INSERT ON `mysql`.`user` TO 'sdb_admin'@'%';
UPDATE `mysql`.`user`
	SET `Reload_priv`='Y', `Process_priv`='Y', `Update_priv`='Y', `Delete_priv`='Y', `Select_priv`='Y'
	WHERE `user`='sdb_admin' AND `host`='%';
FLUSH PRIVILEGES;



MySQL: Limit the size of the innodb temp file:

List size of file:
sudo ls -al var/lib/mysql

-rw-r-----  1 mysql mysql 12582912 Apr 21 13:40 ibtmp1


sudo /etc/init.d/mysql stop

sudo pico /etc/mysql/mysql.conf.d/mysqld.cnf

Add a new line about innodb_temp_data_file_path:
# * InnoDB
#
# InnoDB is enabled by default with a 10MB datafile in /var/lib/mysql/.
# Read the manual for more InnoDB related options. There are many!
innodb_temp_data_file_path = ibtmp1:12M:autoextend:max:5G

sudo /etc/init.d/mysql start



- SPECCHIO is now running within the VM!


—— VM specific issues follow to allow access to the SPECCHIO ports from outside the VM
—- Potentially also useful for non-VM installations …
- Installing nmap to check the ports

yum install nmap

Install firewall GUI: 
yum install system-config-firewall system-config-firewall-tui

- Configured the CentOS firewall as follows:
	- 8080 as other ports with tcp protocol
	— 3306
	- 8181
	

- Works for 8080 connections from the outside using the IP




— Configurations to allow loading of big data files (Campaign Import)  -> easier to use the import from a file stored locally on the server.
Connection Upload Timeout: 300000  -> -1
Upload Timeout: disabled
Read Timeout: 300000 -> 300000



##############################################################################################################
##### THE FOLLOWING IS NOT NEEDED: JUST SOME TRIAL AND ERROR BEFORE FIGURING IT OUT ….

##### Authentication via keystore: Trial and error segment - The solution is to set the hostname before installing Glassfish!
- either hostname is wrong 
- or if recreating the keystore file and cacerts file then the handshaking fails …


http://docs.oracle.com/cd/E18930_01/html/821-2435/ablqz.html

keytool -list -v -keystore /opt/glassfish3/glassfish/domains/domain1/config/keystore_org.jks

-> the keystore.jks has already the wrong hostname in it!!!!!!!!


keytool -genkeypair -keystore keystore.jks  -dname "CN=SPECCHIOVM.specchio.ch, OU=GlassFish, O=Oracle Corporation, L=Santa Clara, ST=California, C=US" -keypass changeit  -storepass changeit  -keyalg RSA  -keysize 2048  -alias specchio_vm_  -ext SAN=DNS:SPECCHIOVM.specchio.ch -validity 9999

- copy new keystore.jks to /opt/glassfish3/glassfish/domains/domain1/config/


keytool -export -alias specchio_vm_ -storepass changeit -file server.cer -keystore keystore.jks

keytool -import -v -trustcacerts -alias specchio_vm_ -file server.cer -keystore cacerts.jks -keypass changeit


keytool -export -alias specchio_vm_ -keystore /opt/glassfish3/glassfish/domains/domain1/config/keystore.jks -file glassfish.crt

keytool -export -alias s1as -keystore /opt/glassfish3/glassfish/domains/domain1/config/keystore.jks -file glassfish.crt

keytool -import -alias specchio_vm_ -file glassfish.crt -keystore specchio.keystore





- copy specchio.keystore from install directory to SPECCHIO WebApp directory



######################################################################################################################



